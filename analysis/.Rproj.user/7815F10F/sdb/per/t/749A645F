{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Analysis_PEGA_2\"\nauthor: \"Katie Lotterhos\"\ndate: \"Jun 28 2017\"\noutput: html_document\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n```\n\n### Load data\nsetwd(\"/Users/katie/Desktop/CurrResearch/1-AdaptreeData/201509_PEGA/analysisV2/\")\n```{r, label=\"load data\"}\nload(\"../data/large_files/Pine_Alpha_AveRho_WithSuperLogical_andAncestralFlip.RData\")\n```\n\nThis loads:\n\n* PE\n* results_pine3 (data frame with SNPs in rows and results in columns)\n* gtcontig_array \n* gtcontig_array_names\n* PE_matchGWAS\n* PE_matchGEA\n\n```{r}\nif(!(\"ash\" %in% installed.packages())){install.packages(\"ash\")}\nif(!(\"corrr\" %in% installed.packages())){install.packages(\"corrr\")}\nif(!(\"igraph\" %in% installed.packages())){install.packages(\"igraph\")}\nif(!(\"ggplot2\" %in% installed.packages())){install.packages(\"ggplot2\")}\nif(!(\"ggraph\" %in% installed.packages())){install.packages(\"ggraph\")}\nif(!(\"dendextend\" %in% installed.packages())){install.packages(\"dendextend\")}\nif(!(\"VennDiagram\" %in% installed.packages())){install.packages(\"VennDiagram\")}\nif(!(\"limma\" %in% installed.packages())){install.packages(\"limma\")}\nif(!(\"fields\" %in% installed.packages())){install.packages(\"fields\")}\nif(!(\"dplyr\" %in% installed.packages())){install.packages(\"dplyr\")}\nif(!(\"limma\" %in% installed.packages())){install.packages(\"limma\")}\nif(!(\"cluster\" %in% installed.packages())){install.packages(\"cluster\")}\nif(!(\"extrafont\" %in% installed.packages())){install.packages(\"extrafont\")}\nif(!(\"RColorBrewer\" %in% installed.packages())){install.packages(\"RColorBrewer\")}\nif(!(\"devtools\" %in% installed.packages())){install.packages(\"devtools\")}\nif(!(\"superheat\" %in% installed.packages())){devtools::install_github(\"rlbarter/superheat\")}\nif(!(\"extrafont\" %in% installed.packages())){install.packages(\"extrafont\")}\n\nif(!(\"limmma\" %in% installed.packages())){\n  source(\"http://www.bioconductor.org/biocLite.R\")\n  biocLite(\"limma\")\n}\n\n  library(RColorBrewer)\n  library(corrr)\n  library(igraph)\n  library(ggplot2)\n  library(ggraph)\n  library(dendextend)\n  library(superheat)\n  require(VennDiagram)\n  require(limma)\n  require(ash)\n  require(fields)\n  require(dplyr)\n  require(cluster)\n\n  library(extrafont) \n  #font_import() \n  loadfonts()\n      \nsource(\"plot2Dcov.R\")\nsource(\"galaxy2.R\")\n```\n\n\nGet incides for different groups of columns in the dataframe\n\n```{r}\n  names(results_pine3)[grep(\"raw_rho\", names(results_pine3))]\n  names(results_pine3)[grep(\"raw_p\", names(results_pine3))]\n  \n### Spearman's rho (not structure-corrected or \"uncorrected\")\n  env_cols <- grep(\"raw_rho\", names(results_pine3))[1:22]\n  rawrho_names <- names(results_pine3)[env_cols] # raw rho columns\n  \n### P-value for Uncorrected Spearman's rho  \n  cols_raw <- grep(\"raw_p\", names(results_pine3))[1:22]\n  rawp_names <- names(results_pine3)[cols_raw ] # raw p columns\n\n### Check to make sure they line up    \n  cbind(names(results_pine3)[env_cols],names(results_pine3)[cols_raw])\n    \n### Bayes Factor from Bayenv2    \n  bayenvBF_names <- sub(\"_raw_p\",\"\",names(results_pine3)[cols_raw])\n  cols_bayenvBF <- which(names(results_pine3) %in% bayenvBF_names)\n\n### Structure-correcte rho from Bayenv2      \n  bayenvrho_names <- paste(bayenvBF_names, \"rhoave\", sep=\"_\")\n  cols_bayenvrho <-which(names(results_pine3) %in% bayenvrho_names)\n\n```\n\n\n## Step 1: Identify top candidate contigs from Yeaman et al. 2016 and identify top candidate SNPs within those contigs\n\n```{r,label=\"Top SNP's from Sam's top candidates\" }\n\n### Subset entire data to top contigs  \n  superdf <- results_pine3[results_pine3$pine_super_p9 | \n                           results_pine3$pine_super_raw_p9,]\n### Set up logical dataframe for identifying outliers     \n  is.superdf <- matrix(NA, nrow(superdf), length(cols_raw))\n  colnames(is.superdf) <- names(results_pine3)[cols_raw]\n\n\n### Identify top candidate SNPs within those contigs\n  ### Top SNPs have a significant Bonferroni-corrected P value for uncorrected Spearmans rho and a Bayes Factor from Bayenv2 > 2\n  ### This is the code that decides top outliers:\n    \n    P_cutoff <- -log10(0.05/(22*nrow(results_pine3)))\n    P_cutoff\n    \n    for (i in 1:length(cols_raw)){\n      cd <- cols_raw[i]\n      cd_bayenv <- cols_bayenvBF[i]\n      P_focal <- -log10(abs(superdf[,cd]))\n      BF_focal <- superdf[,cd_bayenv]\n      is.superdf[,i] <- P_focal>P_cutoff & BF_focal > 2\n      is.superdf[is.na(is.superdf[,i]),i] <- FALSE\n      #sum(is.na(is.superdf[,i]))\n      print( c(i,names(results_pine3)[cd], names(results_pine3)[cd_bayenv]))\n    }\n  num.var.raw.out <- rowSums(is.superdf,na.rm = TRUE)\n  \n  ### total number of SNPs in super contigs\n  nrow(superdf) \n  \n  ### number of all Sam's super contigs\n  length(unique(superdf$gtcontig)) \n  \n  ### number of super SNPs in super contigs\n  sum(num.var.raw.out>0) \n    ## 1241 SNPs without BF cutoff, 801 SNPS with BF cutoff\n\n  ### number of super contigs with superSNPs (# contigs in Group 1)\n  length(unique(superdf$gtcontig[num.var.raw.out>0])) \n    ## 133 contigs without BF cutoff, 108 contigs with BF cutoff\n  \n  \n  ### Dataframe of Group 1\n  Group1_allSuperSNPs <- superdf[num.var.raw.out>0,]\n  dim(Group1_allSuperSNPs)\n  ### Logical Group 1\n  results_pine3$Group1_logical <- results_pine3$gcontig__gcontig_pos %in% Group1_allSuperSNPs$gcontig__gcontig_pos\n  \n  ### Sanity check - number of SNPs in Group 1 the same\n  (Group1_nSNPs <- sum(results_pine3$Group1_logical))\n  \n  ### Sanity check - number of contigs in Group 1 the same\n  (Group1_ncontigs <-length(levels(factor(results_pine3$gtcontig[results_pine3$Group1_logical]))))\n  \n  G1_hist <- sort(table(results_pine3$gtcontig[results_pine3$Group1_logical]),decreasing = TRUE)\n  \n \n  top_contigs <- names(G1_hist)\n```\n\n\n### Compare my list to Yeaman 2016 convergence candidates\nThese are genes we think are true positives because they adapt to climate in both pine and spruce.\n\nYeaman et al. 2016 identified 47 orthologs with FDR correction\n\n```{r}\nsy <- read.table(\"../data/orthologs/parallelism_genes_pine_spruce_q05.txt\")\nhead(sy)\nnrow(sy)\nsy_top <- unique(sy$V1)\nlength(sy_top)\nlength(unique(sy$V2))\n\n### Make sure all contigs in list are in my df\n  for (i in 1:length(sy_top)){\n    cd <- as.character(sy_top[i])\n    if(length(which(sy_top[i]==results_pine3$gtcontig))==0){\n      print(c(i, \"missing\",cd))\n    }\n  }\n  ### If nothing printed that is a good thing!\n\n### Which ones of Group 1 are super convergent outliers\n  sum(top_contigs %in% sy$V1)\n  sum(sy$V1 %in% top_contigs)\n  \n  top_contigs[which(top_contigs %in% sy$V1)]\n  ### We get the same 10 contigs with or without the BF cutoff\n```\nAccording to the above results, 10 of those 47 are in my list of top candidates.\n\n### Group 1 Make some comparison plots\n\nSNPs were coded for association analyses according to alphabetical order. However, we also have the ancestral SNP according to mapping our data onto the loblolly pine genome. The direction of the sign to change the SNP association to one relative to the ancestral state is given by multiplying the SNP association by the column \"Ances_flipNum\".\n\nHere, I am just comparing the patterns between the alphabetical coding and the ancestral coding.\n\n```{r}\nsum(results_pine3$Group1_logical)\nsum(results_pine3$Group1_logical & !is.na(results_pine3$Ances_flipNum), na.rm=TRUE)\n  # number of top candidate SNPs that we have ancestral state for\n\nnames(results_pine3)[grep(\"MAT\", names(results_pine3))]\n```\n\n\n## Co-association network analysis\nThe objective of the next section is to identify groups of SNPs that show similar patterns of association across the multivariate environment.\n\nThis analysis consists of several steps:\n\n1) Cluster the environmental data according to their abs(correlation) with each other.\n\n2) Cluster the SNPs according to their abs(associations) with environments, while holding the order of the environments according to the environmental clustering. Through data visualizations and toy data I've determined that the absolute value here is important, because the sign of the SNP association is arbitrary anyway.\n\n3) Identify groups of SNPs according to how they cluster together.\n\n4) Use undirected network graphs to visualize how contigs and SNPs cluster together.\n\n5) Use galaxy plots to interpret individual SNP correlations in multiple environments relative to the ancestral state.\n\nLoad the Pine environmental data and determine cluster relationships among environments\n```{r}\n### \n  load(\"../data/PineHeatmap.Rdata\")\n  # loads env_clust - this cluster object was not based on signed associations and led to some weird clustering\n    # env_clust$rowInd is the order of environments based on signed clustering\n  env_clust_old <- env_clust\n  env_clust_old$rowInd\n  # raw correlations\n    head(env_clust_old$carpet)\n  # Redo clustering based on abs()\n    cormat <- t(env_clust_old$carpet)\n    cormat <- cormat[,22:1]\n    head(cormat)\n    longnames <- data.frame(rownames(cormat),colnames(cormat))\n    #rownames(cormat) <- colnames(cormat)\n    head(cormat)\n    env_clust <- hclust(abs(dist(as.matrix(cormat))))\n    env_clust$order\n    env_clust$labels\n    env_clust$labels[env_clust$order]\n    rownames(env_clust_old$carpet)\n    rownames(t(env_clust_old$carpet))\n  # heatmap of environments\n    env_clust$labels\n    colnames(cormat)\n    cormat2 <- cormat[env_clust$order, ]\n    #colnames(cormat2)\n    cormat2 <- cormat2[, env_clust$order]\n    head(cormat2)\n    par(mar=c(4,1,1,1))\n    png(\"../results/dendogram_environment.png\", width=12, height=9, units = \"in\", res=500)\n    superheat(cormat2, col.dendrogram = TRUE,#row.dendrogram=TRUE,\n              order.rows = 1:22,\n              order.cols = 1:22,#legend.height = 0.05,\n              left.label.size = 1, bottom.label.size =  0.25,\n              bottom.label.text.angle = 90)\n    dev.off()\n```\n\n\nFirst, take absolute value of the SNP effect sizes b/c of signed nature of alleles\n```{r}\nresults_pine3$gtcontig_pos <-  paste(results_pine3$gtcontig, results_pine3$pos_gcontig, sep=\"_\")\nlabs <- results_pine3$gtcontig_pos\nlabs2 <- gsub(\"_c0_seq1\",replacement = \"\",labs)\nlabs3 <- gsub(\"_c1_seq1\",replacement = \"\",labs2)\nlabs4 <- gsub(\"_c4_seq1\",replacement = \"\",labs3)\nresults_pine3$gtcontig_pos <- labs4\n\n# Distance matrix and hierarchical cluster based on association patterns\n  snp_mat <- abs(results_pine3[results_pine3$Group1_logical, env_cols])\n  rownames(snp_mat) <- results_pine3$gtcontig_pos[results_pine3$Group1_logical]\n  head(snp_mat)\n  snp_dist <- dist(snp_mat, diag=TRUE, upper=TRUE)\n  str(snp_dist)\n  snp_order <- hclust(snp_dist)\n  head(snp_order$labels[snp_order$order])\n\n# Assign cluster membership\n  clusMember = cutree(snp_order, 4)\n  table(clusMember)\n  length(clusMember)\n  results_pine3$cluster[results_pine3$Group1_logical] <- clusMember\n    # 1 is Aridity, 2 is geography, 3 is freezing and 4 is multi\n\n\n# Match order environments in SNPs to order of environments by their associations with each other\n  sample1 = abs(results_pine3[results_pine3$Group1_logical, env_cols])\n  colnames(sample1) <- sub(\"_raw_rho\", \"\", colnames(sample1))\n  colnames(sample1)\n  #need to match this to the environmental clustering\n  dim(sample1)\n  \n  m <- match(colnames(cormat2), colnames(sample1))\n  sample <- sample1[,m]\n  colnames(sample)\n\npng(\"../results/dendogram_ordered.png\", width=12, height=9, units = \"in\", res=500)\nsuperheat(t(sample), \n          order.rows= 1:22,#rev(env_clust_old$rowInd),\n          order.cols = snp_order$order,\n          heat.pal = (brewer.pal(5, \"Blues\")), heat.na.col = \"white\",\n          col.dendrogram = T, row.dendrogram = TRUE,\n            left.label.size = 0.2)\ndev.off()\n\n\n### Compare pattern to structure-corrected rho\n  sample_bayenv = (results_pine3[results_pine3$Group1_logical, cols_bayenvrho])\n  colnames(sample_bayenv) <- sub(\"_rhoave\", \"\", colnames(sample_bayenv))\n  dim(sample_bayenv)\n  m <- match(colnames(cormat2), colnames(sample_bayenv))\n  sample_bv2 <- sample_bayenv[,m]\n  colnames(sample_bv2)\n  \n  png(\"../results/dendogram_ordered_bayenv.png\", width=12, height=9, units = \"in\", res=500)\n    superheat(t(abs(sample_bv2)), \n            order.rows=1:22, #rev(env_clust_old$rowInd),\n            heat.pal = (brewer.pal(5, \"Blues\")),\n            heat.na.col = \"white\",\n            col.dendrogram = TRUE, row.dendrogram = TRUE,\n              left.label.size = 0.2,\n          order.cols = snp_order$order)\n  dev.off()\n```\n  \n## Create Venn Table\n```{r}\nlimit.df <- results_pine3[results_pine3$Group1_logical,]\ndim(limit.df)\n\n### Overlap among SNPs\na<- vennCounts(cbind(limit.df$cluster==1, # aridity\n                     limit.df$cluster==2, # geography\n                     limit.df$cluster==3, # freezing\n                     limit.df$cluster==4)) # multi\n# vennDiagram(a) note that this is meaningless b/c at SNP level\n\n### Overlap among contigs\ncontig.group.df <- data.frame(\n  Multi = table(limit.df$gtcontig,limit.df$cluster==4)[,2],\n  Aridity = table(limit.df$gtcontig,limit.df$cluster==1)[,2],\n  Freezing = table(limit.df$gtcontig,limit.df$cluster==3)[,2],\n  Geography = table(limit.df$gtcontig,limit.df$cluster==2)[,2]\n)\n\n# \"group\" is for contigs - which cluster does the contig belong to\ncontig.group.df$group <- apply(contig.group.df[,1:4],1, FUN = function(x)(which(x==max(x))))\ncontig.group.df$nout <- rowSums(contig.group.df[,1:4])\n\n# cluster is to correspond to SNP df\ncontig.group.df$cluster <- NA\ncontig.group.df$cluster[contig.group.df$group==1] <- \"Multi-4\"\ncontig.group.df$cluster[contig.group.df$group==2] <- \"Aridity-1\"\ncontig.group.df$cluster[contig.group.df$group==3] <- \"Freezing-3\"\ncontig.group.df$cluster[contig.group.df$group==4] <- \"Geography-2\"\n\n###\ncontig.group.df<- contig.group.df[order(contig.group.df$group,contig.group.df$nout, decreasing=c(FALSE, TRUE),method=\"radix\"),]\ncontig.group.df\n\ncontig.group.df$ContigID <- 1:nrow(contig.group.df)\n  \ncontig.group.df$col <- NA\ncontig.group.df$gtcontig <- rownames(contig.group.df)\n\n# Geog\n  whichones <- contig.group.df$group==4\n  ncol <- sum(whichones)\n  ncol\n   fills <- adjustcolor(two.colors(n=ncol, start=\"gold\", middle= \"peachpuff\", \n                                   end=\"lightgoldenrod3\"),alpha=0.9)\n  plot(1:length(fills), col=fills, pch=19, cex=2)\n  contig.group.df$col[whichones] = fills\n  text(1:length(fills), labels=paste(contig.group.df$gtcontig[whichones], \n                                     contig.group.df$ContigID[whichones], sep=\"  \"), cex=0.5)\n  \n# Aridity\n  whichones <- contig.group.df$group==2\n  ncol <- sum(whichones)\n  ncol\n  fills <- adjustcolor(two.colors(n=ncol, start=\"orange\", middle= \"brown2\", end=\"darkorange4\"),alpha=0.9)\n  plot(1:length(fills), col=fills, pch=19, cex=2)\n  contig.group.df$col[whichones] = fills\n  text(1:length(fills), labels=paste(contig.group.df$gtcontig[whichones], \n                                     contig.group.df$ContigID[whichones], sep=\"  \"), cex=0.5)\n  \n# Multi\n  whichones <- contig.group.df$group==1\n  ncol <- sum(whichones)\n  ncol\n  fills <- adjustcolor(c(\"#DAF7A6\", \"chartreuse4\", \"#28B463\"), alpha=0.9)\n  plot(1:length(fills), col=fills, pch=19, cex=2)\n  contig.group.df$col[whichones] = fills\n  text(1:length(fills), labels=paste(contig.group.df$gtcontig[whichones], \n                                     contig.group.df$ContigID[whichones], sep=\"  \"), cex=0.5)\n  \n\n# Freezing\n  whichones <- contig.group.df$group==3\n  ncol <- sum(whichones)\n  ncol\n  fills <- adjustcolor(two.colors(n=ncol, start=\"darkturquoise\", middle= \"dodgerblue\", end=,\"darkslategrey\"),alpha=0.9)\n  plot(1:length(fills), col=fills, pch=19, cex=2)\n  contig.group.df$col[whichones] = fills\n  text(1:length(fills), labels=paste(contig.group.df$gtcontig[whichones], \n                                     contig.group.df$ContigID[whichones], sep=\"  \"), cex=0.5)\n  \n  \ncontig.group.df\n```\n\nAdd GO terms and super convergent status (Yeaman 2016) to contig.group.df\n```{r}\n### Super convergent status\n  conv.ind <- which(contig.group.df$gtcontig %in% sy$V1)\n  contig.group.df$is.convergent <- FALSE\n  contig.group.df$is.convergent[conv.ind ] <- TRUE\n  contig.group.df[conv.ind ,]\n\n### GO terms\n  go.df <- read.table(\"../data/tair_pine_clusterall\", header=TRUE)\n  head(go.df)\n  dim(go.df)\n  go.df$pine_comp <- paste(go.df$pine_comp, \"_seq1\", sep=\"\")\n  m1<- match(go.df$pine_comp, contig.group.df$gtcontig)\n  names(go.df)[1] <- \"gtcontig\"\n  contig.group.df2<-merge(contig.group.df,go.df, all.x=TRUE)\n  contig.group.df2 <- contig.group.df2[order(contig.group.df2$ContigID),]\n  write.csv(contig.group.df2, \"../results/topCandidateContigs.csv\")\n```\n\n\nMake Pine Venn Barplot with contig colors\n```{r}\ntoplot <- t(as.matrix(contig.group.df[,1:4]))\n  head(toplot)\n  dim(toplot)\n  #dim(contigdat)\n  colnames(toplot) <- contig.group.df$ContigID\n\npdf(\"../results/PineVenn_horiz.pdf\", width=20, height=6)\n  par(mar=c(6,6, 1,1))\n  b<- barplot(toplot, beside = FALSE, horiz = FALSE, las=2, col=c(\"lightgreen\", \"orange\", \"lightblue\",  \"yellow\"), cex.names=1, cex.axis = 2,  border = c(\"darkgreen\", \"brown\", \"blue\",  \"brown\"), cex=2,  ylab=\"Number of SNPs\", xlab= \"Contig ID\", ylim=c(-8,50), names.arg = rep(\"\", 108), cex.lab=2)\n\n  legend(100, 30, c(\"Multi\", \"Aridity\", \"Freezing\",  \"Geography\"), bty=\"n\", fill=c(\"lightgreen\", \"orange\", \"lightblue\",  \"yellow\"), border = c(\"darkgreen\", \"brown\", \"blue\",  \"brown\"), cex=2)\n\n  points(b, rep(-1,108), pch=20, col=contig.group.df$col, cex=2)\n  text(b, rep(-2, 108), colnames(toplot), col=contig.group.df$col, srt=90, adj=1) \n  convt <- rep(\"\", 108)\n  convt[contig.group.df$is.convergent] <- \"*\"\n  text(b, rep(-5.5,108), convt)\ndev.off()\n```\n\nAnnotation barplot\n\n```{r}\nann2 <- as.character(results_pine3$X_annotation)\nann2[grep(\"nonsyn*\",ann2)] <- \"nonsyn\"\n\nall_an <- table(ann2)\nout_an <- table(ann2[results_pine3$Group1_logical])\n\ncompare_ann <- merge(data.frame( all_an/sum(all_an)), data.frame(out_an/sum(out_an)) , by.x=\"ann2\", by.y=\"Var1\", all.x=TRUE)\n\nhead(compare_ann)\ncompare_ann <- compare_ann[-which(compare_ann$ann2 %in% c(\"HAS_INDEL\", \"mismatch_altref\", \"multi-allelic\")),]\n\ncompare_ann\n\npdf(\"../results/annotation.pdf\", width=8, height=5)\n  par(mar=c(8,4,1,1))\n  barplot(t(as.matrix(compare_ann[,2:3])), beside=TRUE, ylab=\"Proportion\", names.arg = compare_ann$ann2, las=2)\n  legend(20, 0.5, c(\"All SNPs\", \"Top Candidates\"), fill=c(\"grey30\", \"grey80\"))\ndev.off()\n```\n\n## Co-association network\n\n#### Function to draw network based on distance matrix\n```{r}\nshortclust <- results_pine3$cluster[results_pine3$Group1_logical]\nsource(\"myFunDist.R\")\n### In contig.group.df, \"group\" is for clusterID and plotting order, but not equal to cluster given by the SNP\n\nMakeDistNetwork <- function(clustnum, filename, disthreshold, full_name=FALSE){\n  \n  ### Based on correlation in associations (co-association)\n  #names(results_pine3)[env_cols]\n  #multidat <- abs(results_pine3[which(results_pine3$cluster==clustnum), env_cols])\n  #str(multidat)\n  #rownames(multidat) <- results_pine3$gtcontig_pos[which(results_pine3$cluster==clustnum)]\n  #dim(multidat)\n  \n  snp_distmat_multi <- snp_distmat[shortclust ==clustnum, shortclust ==clustnum]\n  print(dim(snp_distmat_multi))\n  head(snp_distmat_multi[1:5, 1:5])\n  \n  #hist(snp_distmat_multi)\n  # This histogram is bimodal with the larger values > 0.4\n\n  d4_multi <- myFun(as.dist(snp_distmat_multi))\n  head(d4_multi)\n  #hist(d4_multi$value)\n  \n  (nedges <- nrow(d4_multi %>%\n    filter(abs(d4_multi$value) < disthreshold)))\n  \n  print(c(\"Number of edges:\", nedges))\n  if(nedges > 30000){print(\"Too many edges\"); break}\n  \n  \n  graph_cors <- d4_multi %>%\n    filter(value < disthreshold) %>% #filter to close distances\n    graph_from_data_frame(directed = FALSE)\n  \n    # check node names and add nodes if they are missing\n    V(graph_cors)$name\n    toadd <- !(rownames(snp_distmat_multi) %in% V(graph_cors)$name)\n    sum(toadd)\n    graph_cors2 <- add_vertices(graph_cors, nv = sum(toadd, na.rm=TRUE), name= rownames(snp_distmat_multi)[toadd])\n    V(graph_cors2)$name\n    sum(!(rownames(snp_distmat_multi) %in% V(graph_cors2)$name))\n      #should be 0 because nothing missing\n    graph_cors <- graph_cors2\n    \n    # line up names\n    (myo <- match(V(graph_cors)$name, results_pine3$gtcontig_pos))\n    \n    contigname = results_pine3$gtcontig[myo]\n    \n    myocol <- contig.group.df$col[match(contigname, contig.group.df$gtcontig)]\n    \n    if(full_name==FALSE){\n    myoname <- as.character(contig.group.df$ContigID[match(contigname, contig.group.df$gtcontig)])\n    }\n    if(full_name==TRUE){\n      myoname <- as.character(V(graph_cors)$name)\n    }\n    \n\n   #cluster membership\n   mem=clusters(graph_cors)$membership\n   \n   # number edges for each node\n   nodenumedge <- sapply(V(graph_cors)$name, function(x) length(E(graph_cors)[from(V(graph_cors)[x])]))\n   \n  \n   png(file = paste(\"../results/NetworkDist2Hist\", filename,\".pdf\", sep=\"\"), width=15, height=15, units=\"in\", res=300)\n   hist(d4_multi$value)\n   lines(x=c(disthreshold, disthreshold), y=c(0,1000), col=\"blue\", lwd=5)\n   dev.off()\n\n    ggraph(graph_cors) +\n    geom_edge_fan2(aes(edge_alpha = 0.01)) +\n    guides(edge_alpha = \"none\", edge_width = \"none\") +\n    #scale_edge_colour_gradientn(limits = c(-1, 1), \n    #                            colors = c(\"firebrick2\", \"dodgerblue2\")) +\n    geom_node_point(color = myocol, size = 15) +\n    geom_node_text(aes(label = myoname, size=0.1)) +\n    theme_graph() #+\n    #labs(title = filename)\n  \n    options(warn=-1)\n\n    ggsave(paste(\"../results/Network\", filename,disthreshold, full_name,\"dist.pdf\", sep=\"_\"), width=15, height=15, units=\"in\")\n  \n     if(identical(names(nodenumedge), names(mem))){\n    return(data.frame(gtcontig_pos=names(mem), subcluster=mem, numedge=nodenumedge))\n   }else{\n     print(\"error: node names and edge names not identical\")\n   }\n\n} # end function\n```\n\n```{r}\ncolSums(table(results_pine3$gtcontig[results_pine3$Group1_logical], results_pine3$cluster[results_pine3$Group1_logical]))\nsnp_distmat <- as.matrix(snp_dist)\nresults_pine3$subcluster <- NA\nresults_pine3$numedges <- NA\nresults_pine3$allele <- NA\n\n#### Multi Dist Network ####\nmm <- MakeDistNetwork(4, \"Multi\", 0.1) \n  # if you get an error here about invalid font type, be sure to \n  # uncomment the \"#font_import()\" at the setup in the beginning of the code\n  # and then loadfonts()\n  head(mm)\n  hist(mm$subcluster)\n  ### Assign subcluster membership and number edges\n  mind <- match(mm$gtcontig_pos, results_pine3$gtcontig_pos)\n  results_pine3$subcluster[mind] <- mm$subcluster\n  results_pine3$numedges[mind] <- mm$numedge\n  ### Assign allele ID based on sign of association determined from data vis\n  ### For Multi group is it MAT\n    results_pine3$allele[mind][results_pine3$MAT_raw_rho[mind]*results_pine3$Ances_flipNum[mind]>0]<- \"+\"\n    results_pine3$allele[mind][results_pine3$MAT_raw_rho[mind]*results_pine3$Ances_flipNum[mind]<0]<- \"-\"\n  which(names(results_pine3)==\"MAT_raw_rho\")      \n  \n  # Number of alleles \"evolving\" in each direction relative to ancestor\n  table(results_pine3$allele[mind])  \n  # direction of SNPs in each contig\n  table(results_pine3$gtcontig[mind], results_pine3$allele[mind])\n\n#### Aridity Dist Network ####\nrm(mm)\nmm <- MakeDistNetwork(1, \"Aridity\", 0.1) \n  head(mm)\n  hist(mm$subcluster)\n  ### Assign subcluster membership and number edges\n  mind <- match(mm$gtcontig_pos, results_pine3$gtcontig_pos)\n  results_pine3$subcluster[mind] <- mm$subcluster\n  results_pine3$numedges[mind] <- mm$numedge\n  ### Assign allele ID based on sign of association determined from data vis\n  ### For Aridity group is it MAT\n    results_pine3$allele[mind][results_pine3$MAT_raw_rho[mind]*results_pine3$Ances_flipNum[mind]>0]<- \"+\"\n    results_pine3$allele[mind][results_pine3$MAT_raw_rho[mind]*results_pine3$Ances_flipNum[mind]<0]<- \"-\"\n\n  table(results_pine3$allele[mind]) \n  # direction of SNPs in each contig\n  table(results_pine3$gtcontig[mind], results_pine3$allele[mind])\n  \n#### Geography Dist Network ####\nrm(mm)\nmm <- MakeDistNetwork(2, \"Geography\", 0.1) \n  head(mm)\n  hist(mm$subcluster)\n  ### Assign subcluster membership and number edges\n  mind <- match(mm$gtcontig_pos, results_pine3$gtcontig_pos)\n  results_pine3$subcluster[mind] <- mm$subcluster\n  results_pine3$numedges[mind] <- mm$numedge\n  ### Assign allele ID based on sign of association determined from data vis\n  ### For Geography group is it MAT ????\n    results_pine3$allele[mind][results_pine3$MAT_raw_rho[mind]*results_pine3$Ances_flipNum[mind]>0]<- \"+\"\n    results_pine3$allele[mind][results_pine3$MAT_raw_rho[mind]*results_pine3$Ances_flipNum[mind]<0]<- \"-\"\n\n  table(results_pine3$allele[mind]) \n  # direction of SNPs in each contig\n  table(results_pine3$gtcontig[mind], results_pine3$allele[mind])\n  \n#### Freezing Dist Network ####\nrm(mm)\nmm <- MakeDistNetwork(3, \"Freezing\", 0.1)\n  head(mm)\n  ### Assign subcluster membership and number edges\n  hist(mm$subcluster)\n  mind <- match(mm$gtcontig_pos, results_pine3$gtcontig_pos)\n  results_pine3$subcluster[mind] <- mm$subcluster\n  results_pine3$numedges[mind] <- mm$numedge\n  ### Assign allele ID based on sign of association determined from data vis\n  ### For Freezing group is it LAT & Elevation\n    results_pine3$allele[mind][results_pine3$MAT_raw_rho[mind]*results_pine3$Ances_flipNum[mind]>0]<- \"+\"\n    results_pine3$allele[mind][results_pine3$MAT_raw_rho[mind]*results_pine3$Ances_flipNum[mind]<0]<- \"-\"\n\n  # total num SNPs increasing in freq in each direction of MAT\n  table(results_pine3$allele[mind]) \n  # direction of SNPs in each contig\n  table(results_pine3$gtcontig[mind], results_pine3$allele[mind])\n  \n### Number of contigs in each cluster/subcluster combo\n  tapply(results_pine3$gtcontig, list(results_pine3$cluster, results_pine3$subcluster), function(x){length(levels(as.factor(x)))})\n  # 1 is aridity\n  # 2 is geography\n  # 3 is freezing\n  # 4 is multi\n  # each column is a submodule\n```\n\n\n## Add info\n\n```{r}\n#match SNP colors to contig dat\n# Cluster color for outline\n  #Aridity = table(limit.df$gtcontig,limit.df$cluster==1)[,2],\n  #Geography = table(limit.df$gtcontig,limit.df$cluster==2)[,2],\n  #Freezing = table(limit.df$gtcontig,limit.df$cluster==3)[,2],\n  #Multi = table(limit.df$gtcontig,limit.df$cluster==4)[,2]\n  #adjustcolor(\"yellow\",0.5)(\"brown\",0.5)\n  #adjustcolor(\"lightgreen\",0.5) (\"darkgreen\",0.5)\n  #adjustcolor(\"orange\",0.5) (\"brown\",0.5)\n  #adjustcolor(\"lightblue\",0.5) adjustcolor(\"blue\",0.5)\n  results_pine3$clustercol[results_pine3$cluster==1] = \"orange\"\n  results_pine3$clustercol[results_pine3$cluster==2] = \"yellow\"\n  results_pine3$clustercol[results_pine3$cluster==3] = \"blue\"\n  results_pine3$clustercol[results_pine3$cluster==4] = \"green\"\n  table(as.character(results_pine3$clustercol[results_pine3$Group1_logical]))\n  \n  # num snps\n  (t1 <- table(as.character(results_pine3$cluster[results_pine3$Group1_logical])))\n  sum(t1)\n  # num contigs\n  (t2<- sapply(1:4, function(x) length(table(results_pine3$gtcontig[results_pine3$cluster==x]))))\n  sum(t2)\n  \n# Contig color for points\n  m <- match(results_pine3$gtcontig[results_pine3$Group1_logical], contig.group.df$gtcontig)\n  m\n  results_pine3$contigcol[results_pine3$Group1_logical] <- contig.group.df$col[m]\n\n  results_pine3$contigID <- NA\n  results_pine3$contigID[results_pine3$Group1_logical] <- contig.group.df$ContigID[m]\n  results_pine3$group[results_pine3$Group1_logical] <- contig.group.df$group[m]\n  \n  write.csv(results_pine3[results_pine3$Group1_logical,], file = \"../results/PineTopCandidates.csv\")\n\n\n  table(results_pine3$cluster, results_pine3$pine_super_convergent)\n    # super convergent SNPs found in elevation freezing group or geography group\n  \n```\n   \n   \n## Galaxy plots\n\n```{r} \npdf(file = \"../results/GalaxyExample_inMATvMAP2.pdf\", width=5, height=5)\nx<- results_pine3$MAT_raw_rho*results_pine3$Ances_flipNum\ny <- results_pine3$MAP_raw_rho*results_pine3$Ances_flipNum\npar(mar=c(6,6,1,1))\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between allele frequency and\\nMean Annual Temperature\", \n       ylab= \"Spearman's rho between allele frequency and\\nMean Annual Precipitation\" , \n       nbin=100, xlim=c(-0.8,0.8), ylim=c(-0.8,0.8),PE=0.33, PElab=c(\"MAT\", \"MAP\"))\ndev.off()\n\npdf(file = \"../results/GalaxyExample_inMATvMAP2_Group1.pdf\", width=5, height=5)\nx<- results_pine3$MAT_raw_rho*results_pine3$Ances_flipNum\ny <- results_pine3$MAP_raw_rho*results_pine3$Ances_flipNum\npar(mar=c(6,6,1,1))\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between allele frequency and\\nMean Annual Temperature\", \n       ylab= \"Spearman's rho between allele frequency and\\nMean Annual Precipitation\" , \n       x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       sub_outlinecolor = \"red\",\n       sub_bgcolor = \"blue\",\n       nbin=100, xlim=c(-0.8,0.8), ylim=c(-0.8,0.8),PE=0.33, PElab=c(\"MAT\", \"MAP\"))\ndev.off()\n\n\npdf(file = \"../results/GalaxyExample_inMATvMAP2_EachGroup.pdf\", width=5, height=5)\npar(mar=c(6,6,1,1))\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between allele frequency and\\nMean Annual Temperature\", \n       ylab= \"Spearman's rho between allele frequency and\\nMean Annual Precipitation\" , \n       x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       nbin=100, xlim=c(-0.8,0.8), ylim=c(-0.8,0.8),PE=0.33, PElab=c(\"MAT\", \"MAP\"),\n       sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n       sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical]\n)\ndev.off()\n\n\npdf(file = \"../results/GalaxyNew_inMATvMAP2.pdf\", width=8, height=13)\npar(mfrow=c(3,2), mar=c(6,6,1,1), oma = c(4, 0, 1, 0))\n\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between allele frequency and\\nMean Annual Temperature\", \n       ylab= \"Spearman's rho between allele frequency and\\nMean Annual Precipitation\" , \n       nbin=100, xlim=c(-0.8,0.8), ylim=c(-0.8,0.8),\n       x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n       sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n       PE=0.33, PElab=c(\"MAT\", \"MAP\"))\n  text(-0.7, 0.7, \"A\", cex=2)\n  mtext(\"Associations\", side=3)\n\nx<- results_pine3$MAT_rhoave*results_pine3$Ances_flipNum\ny <- results_pine3$MAP_rhoave*results_pine3$Ances_flipNum\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between structure-corrected\\nallele frequency and Mean Annual Temperature\", \n       ylab= \"Spearman's rho between structure-corrected\\nallele frequency and Mean Annual Precipitation\" , \n       nbin=100, xlim=c(-0.3,0.3), ylim=c(-0.3,0.3),\n      x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n       sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n       PE=0.33, PElab=c(\"MAT\", \"MAP\"))\n  text(-0.25, 0.25, \"B\", cex=2)\n  mtext(\"Structure-corrected associations\", side=3)\n\n### MAT VS ELVATION\nx<- results_pine3$MAT_raw_rho*results_pine3$Ances_flipNum\ny <- results_pine3$ELEVATION_raw_rho*results_pine3$Ances_flipNum\n\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between allele frequency and\\nMean Annual Temperature\", \n       ylab= \"Spearman's rho between allele frequency and Elevation\" , \n       nbin=100, xlim=c(-0.8,0.8), ylim=c(-0.8,0.8),\n       x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n       sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n       PE=-0.48, PElab=c(\"MAT\", \"ELEVATION\"))\n  text(-0.7, 0.7, \"C\", cex=2)\n\nx<- results_pine3$MAT_rhoave*results_pine3$Ances_flipNum\ny <- results_pine3$ELEVATION_rhoave*results_pine3$Ances_flipNum\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between structure-corrected\\nallele frequency and Mean Annual Temperature\", \n       ylab= \"Spearman's rho between structure-corrected\\nallele frequency and Elevation\" , \n       nbin=100, xlim=c(-0.3,0.3), ylim=c(-0.3,0.3),\n      x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n       sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n      PE=-0.48, PElab=c(\"MAT\", \"ELEVATION\"))\n  text(-0.25, 0.25, \"D\", cex=2)\n\n### MAT VS LAT\nx<- results_pine3$MAT_raw_rho*results_pine3$Ances_flipNum\ny <- results_pine3$LAT_raw_rho*results_pine3$Ances_flipNum\n\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between allele frequency and\\nMean Annual Temperature\", \n       ylab= \"Spearman's rho between allele frequency and Latitude\" , \n       nbin=100, xlim=c(-0.8,0.8), ylim=c(-0.8,0.8),\n       x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n       sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n       PE=-0.48, PElab=c(\"MAT\", \"LAT\"))\n    text(-0.7, 0.7, \"E\", cex=2)\n\nx<- results_pine3$MAT_rhoave*results_pine3$Ances_flipNum\ny <- results_pine3$LAT_rhoave*results_pine3$Ances_flipNum\ngalaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between structure-corrected\\nallele frequency and Mean Annual Temperature\", \n       ylab= \"Spearman's rho between structure-corrected\\nallele frequency and Latitude\" , \n       nbin=100, xlim=c(-0.3,0.3), ylim=c(-0.3,0.3),\n      x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n       sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n      PE=-0.48, PElab=c(\"MAT\", \"LAT\"))\n  text(-0.25, 0.25, \"F\", cex=2)\n  \n  par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)\nplot(0, 0, type = \"n\", bty = \"n\", xaxt = \"n\", yaxt = \"n\")\nlegend(\"bottom\", c(\"Multi\", \"Aridity\", \"Freezing\", \"Geography\"), xpd = TRUE, horiz = TRUE, inset = c(0, \n    0), bty = \"n\", pch = 21, col= c(\"green\", \"orange\", \"blue\", \"yellow\"), pt.bg = c(\"darkgreen\", \"brown2\", \"lightblue\", \"goldenrod\"), cex = 2)\n# xpd = TRUE tells R that it is OK to plot outside the region horiz = TRUE\n# tells R that I want a horizontal legend inset = c(x,y) tells R how to move\n# the legend relative to the 'bottom' location bty = 'n' means that 'no' box\n# will be drawn around it pch and col are the types and colors of points cex\n# = 2 makes the legend twice as large as other fonts\n\ndev.off()\n```\n\n## Galaxy plots in PC environments\n```{r}\nhist(log10(results_pine3$bayenv_PCA1)) # these are BF\nhist(log10(results_pine3$bayenv_PCA2)) # these are BF\nx <- log10(results_pine3$bayenv_PCA1)\ny <- log10(results_pine3$bayenv_PCA2)\nz <- log10(results_pine3$bayenv_PCA3)\nmin(x); min(y); min(z)\n\npdf(\"../results/PCenvi_BF.pdf\", width=5, height=8)\npar(mar=c(4,4,1,1), mfrow=c(2,1))\ngalaxyplot(x,y, nbin=100, xlim=c(-1.6,20), ylim=c(-1.6,20),\n           xlab = \"BF in PCA1\", ylab=\"BF in PCA2\",\n           x_sub=x[results_pine3$Group1_logical], \n           y_sub=y[results_pine3$Group1_logical],\n          sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n          sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n          plotPE=FALSE, plot0=FALSE)\n  abline(v = 2)\n  abline(h = 2)\n  text(0, 18, \"A\")\n  # \n  # galaxyplot(x,y, nbin=100, xlim=c(-1.6,8), ylim=c(-1.6,8),\n  #          xlab = \"BF in PCA1\", ylab=\"BF in PCA2\",\n  #          x_sub=x[results_pine3$Group1_logical], \n  #          y_sub=y[results_pine3$Group1_logical],\n  #         sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n  #         sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n  #         plotPE=FALSE, plot0=FALSE)\n  #   abline(v = 2)\n  #   abline(h = 2)\n  #     text(-1, 7, \"B\")\n    \ngalaxyplot(x,z, nbin=100, xlim=c(-1.6,20), ylim=c(-1.6,20),\n           xlab = \"BF in PCA1\", ylab=\"BF in PCA3\",\n           x_sub=x[results_pine3$Group1_logical], \n           y_sub=z[results_pine3$Group1_logical],\n          sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n          sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n          plotPE=FALSE, plot0=FALSE)\n  abline(v = 2)\n  abline(h = 2)\n      text(0, 18, \"B\")\ndev.off()  \n\n\ntable(results_pine3$cluster)\ntable(results_pine3$clustercol)\n  # cluster that SNP belongs to\ntable(results_pine3$group)\n  # slight differences here because this is cluster that CONTIG belongs to\n  # (not really relevant for SNPs)\n\nplot(log10(results_pine3$bayenv_PCA1[which(results_pine3$clustercol==\"blue\")]), \n     log10(results_pine3$bayenv_PCA2[which(results_pine3$clustercol==\"blue\")]))\n\ntable(results_pine3$clustercol==\"blue\" & results_pine3$bayenv_PCA1 > 2)\n\ntable(log10(results_pine3$bayenv_PCA1[results_pine3$group==2]) > 2)\n\n# Number missed by 1st PC\np1 <- table(results_pine3$clustercol, log10(results_pine3$bayenv_PCA1)>2 )\np1[,1]/rowSums(p1) # number missed\n\n# Number missed by 2nd PC\np2 <- table(results_pine3$clustercol,  log10(results_pine3$bayenv_PCA2)>2 )\np2[,1]/rowSums(p2) # number missed\n\n# Number missed by 3rd PC\np3 <- table(results_pine3$clustercol,log10(results_pine3$bayenv_PCA3)>2)\np3[,1]/rowSums(p3) # number missed\n\n\n\nlog10(results_pine3$bayenv_PCA3)[which(results_pine3$clustercol==\"orange\")]\nlog10(results_pine3$bayenv_PCA3)[which(results_pine3$clustercol==\"orange\")]\n\n# Number missed by 1st 10 PCs\np10 <- table(results_pine3$clustercol, log10(results_pine3$bayenv_PCA1)>2 |\n        log10(results_pine3$bayenv_PCA2)>2 | \n        log10(results_pine3$bayenv_PCA3)>2 |\n        log10(results_pine3$bayenv_PCA4)>2 |\n        log10(results_pine3$bayenv_PCA5)>2 |\n        log10(results_pine3$bayenv_PCA6)>2 |\n        log10(results_pine3$bayenv_PCA7)>2 |\n        log10(results_pine3$bayenv_PCA8)>2 |\n        log10(results_pine3$bayenv_PCA9)>2 |\n        log10(results_pine3$bayenv_PCA10)>2 \n      )\np10[,1]/rowSums(p10) # number missed\n\n# Freezing and geography groups would have been largely missed\n\nx <- results_pine3$bayenv_PCA1_rhoave\ny <- results_pine3$bayenv_PCA2_rhoave\npar(mar=c(6,6,1,1))\ngalaxyplot(x,y, nbin=100, xlim=c(-0.3,0.3), ylim=c(-0.3,0.3),\n           xlab = \"BF in PCA1\", ylab=\"BF in PCA2\",\n           x_sub=x[results_pine3$Group1_logical], \n           y_sub=y[results_pine3$Group1_logical],\n          sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n          sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n          plotPE=TRUE)\n\nx <- results_pine3$bayenv_PCA1_rhoave\ny <- results_pine3$bayenv_PCA3_rhoave\npar(mar=c(6,6,1,1))\ngalaxyplot(x,y, nbin=100, xlim=c(-0.3,0.3), ylim=c(-0.3,0.3),\n           xlab = \"BF in PCA1\", ylab=\"BF in PCA3\",\n           x_sub=x[results_pine3$Group1_logical], \n           y_sub=y[results_pine3$Group1_logical],\n          sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n          sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n          plotPE=TRUE)\n\n```\n\n\n## Galaxy in multivariate environments\n\n```{r}\n\nwhichvars <- c(\"MAT\",\"MAP\", \"LAT\", \"MSP\", \"MWMT\", \"PAS\" , \"MCMT\") #Eref\n\npdf(\"../results/multvariateEnviGalaxy4clusters.pdf\", width=4*length(whichvars), height=4*length(whichvars))\npar(mfrow=c(length(whichvars), length(whichvars)), mar=c(0.3,0.7,0,0.7), oma=c(10,10,0,0))\nfor (i in 1:length(whichvars)){\n  for (j in 1:length(whichvars)){\n    if(i==j){\n      plot(1,1,bty=\"n\", xaxt=\"n\", yaxt=\"n\", xlab=\"\", ylab=\"\", col=\"white\")\n      text(1,1, whichvars[i], cex=5)  \n    }\n    if(j>i){\n      plot(1,1,bty=\"n\", xaxt=\"n\", yaxt=\"n\", xlab=\"\", ylab=\"\", col=\"white\")\n      if(j==2 & i==1){\n        legend(1,1, legend = c(\"Freezing\", \"Aridity\", \"Multi\", \"Geography\"), \n               pch=c(22,24,21), cex=4, bty=\"n\",xjust=0.5,yjust=0.5,\n               col=c(\"blue\", \"brown\", \"darkgreen\", \"brown\"), \n               pt.bg=c(\"lightblue\", \"orange\", \"lightgreen\", \"yellow\"))\n      }\n    }\n      \n    if(i>j){\n      print(c(i,j))\n      print(c(whichvars[j], whichvars[i]))\n      # Get EE corr\n      ri <- grep(paste(\"^\",whichvars[j],sep=\"\"),rownames(cormat2)) #env_clust$carpet))\n      cj <- grep(paste(\"^\",whichvars[i],sep=\"\"),colnames(cormat2))#env_clust$carpet))\n      print(c(rownames(cormat2)[ri], colnames(cormat2)[cj]))\n      PE<- round(cormat2[ri,cj],2)\n      \n      whichx <- which(names(results_pine3)==paste(whichvars[j], \"_raw_rho\", sep=\"\"))\n      whichy <- which(names(results_pine3)==paste(whichvars[i], \"_raw_rho\", sep=\"\"))\n      print(names(results_pine3)[c(whichx,whichy)])\n      x <- results_pine3[,whichx]*results_pine3$Ances_flipNum\n      y <- results_pine3[,whichy]*results_pine3$Ances_flipNum\n      \n      galaxyplot(x=x, y=y, \n       xlab= \"Spearman's rho between allele frequency and\\nMean Annual Temperature\", \n       ylab= \"Spearman's rho between allele frequency and Latitude\" , \n       nbin=100, xlim=c(-0.8,0.8), ylim=c(-0.8,0.8),\n       x_sub=x[results_pine3$Group1_logical], \n       y_sub=y[results_pine3$Group1_logical],\n       sub_outlinecolor = results_pine3$clustercol[results_pine3$Group1_logical],\n       sub_bgcolor = results_pine3$contigcol[results_pine3$Group1_logical],\n       PE=PE, PElab=c(whichvars[i], whichvars[j]))\n    } # end if\n  } # end j\n} # end i\n  mtext(text = \"Correlation between allele frequency and environment (in column)\", side=1, outer=TRUE, line=5, cex=3, adj=0.1)\n  mtext(text = \"Correlation between allele frequency and environment (in row)\", side=2, outer=TRUE, line=5, cex=3, adj=0.1)\ndev.off()\n```\n\n# Other data visualization\n```{r} \npdf(\"../results/HistTopSNPs.pdf\", width=10, height=6)\n  barplot(G1_hist, xlab=\"Contig\", ylab=\"Number of SNPs\", main=paste(\"Distribution of\",Group1_nSNPs, \"top SNPs\", \"in\",Group1_ncontigs, \"contigs\"), las=2, cex.names=0.3)\ndev.off()\n \nis.superdf2 <- is.superdf[num.var.raw.out>0,]\ncolnames(is.superdf2) <- sub(\"_raw_p\", \"\", colnames(is.superdf))\n\npdf(\"../results/HistOutliersPerEnvi.pdf\", width=10, height=6)\n  par(mar=c(6,6,1,1))\n  barplot(colSums(is.superdf2), las=2)\ndev.off()\n\nlibrary(gplots)\nsource(\"http://www.bioconductor.org/biocLite.R\")\nbiocLite(\"limma\")\nlibrary(limma)\n\nhead(is.superdf2)\na <- vennCounts(is.superdf2[,c(1, 2, 3, 4, 10)])\na\npdf(\"../results/VennEx.pdf\", width=6, height=6)\n  vennDiagram(a)\ndev.off()  \n```\n\nExtra analysis: make galaxy plots for Kay's paper\nOne thought might be to show the results for winter cold injury (and height season 2?) since these are the ones with the most contrasting effects of population structure. \n```{r, eval=FALSE, echo=FALSE}\npdf(\"../results/Fig4Kay.pdf\", width=6, height=10)\npar(mfcol=c(3,2), oma=c(0,0,2,0), mar=c(4,5,1.5,0.5), cex.lab=1.5)\n## Winter cold injury\nplot2Dcov(x=results_pine3$Winter_cold_injury_p_raw_rho, \n          y= results_pine3$Winter_cold_injury_snp_effect, \n          nbin=100, PElab = c(\"x\", \"y\"), \n          PE = cor(results_pine3$Winter_cold_injury_p_raw_rho, \n                   results_pine3$Winter_cold_injury_snp_effect, use=\"pairwise\"),\n          xlim=c(-0.6,0.6), ylim=c(-0.8,0.8),\n          xlab=\"Uncorrected correlation\",\n          ylab=\"GCTA effect size\"\n          )\nplot2Dcov(x=results_pine3$Winter_cold_injury_p_raw_rho,\n          results_pine3$Winter_cold_injury_rhoave_BAYENV, \n          nbin=100, PElab = c(\"x\", \"y\"), \n          PE = cor(results_pine3$Winter_cold_injury_p_raw_rho, \n                   results_pine3$Winter_cold_injury_rhoave_BAYENV, use=\"pairwise\"),\n          xlim=c(-0.6,0.6), ylim=c(-0.3,0.3),\n          xlab=\"Uncorrected correlation\",\n          ylab=\"Covariance-corrected correlation\"\n          )\nplot2Dcov(x=results_pine3$Winter_cold_injury_snp_effect,\n          results_pine3$Winter_cold_injury_rhoave_BAYENV, \n          nbin=100, PElab = c(\"x\", \"y\"), \n          PE = cor(results_pine3$Winter_cold_injury_snp_effect, \n                   results_pine3$Winter_cold_injury_rhoave_BAYENV, use=\"pairwise\"),\n          xlim=c(-1,1), ylim=c(-0.3,0.3),\n          xlab=\"GCTA effect size\",\n          ylab=\"Covariance-corrected correlation\"\n          )\n          \n## Winter cold injury\nplot2Dcov(x=results_pine3$Height_season_2_p_raw_rho, \n          y= results_pine3$Height_season_2_snp_effect, \n          nbin=100, PElab = c(\"x\", \"y\"), \n          PE = cor(results_pine3$Height_season_2_p_raw_rho, \n                   results_pine3$Height_season_2_snp_effect, use=\"pairwise\"),\n          xlim=c(-0.6,0.6), ylim=c(-0.8,0.8),\n          xlab=\"Uncorrected correlation\",\n          ylab=\"GCTA effect size\"\n          )\nplot2Dcov(x=results_pine3$Height_season_2_p_raw_rho,\n          results_pine3$Height_season_2_rhoave_BAYENV, \n          nbin=100, PElab = c(\"x\", \"y\"), \n          PE = cor(results_pine3$Height_season_2_p_raw_rho, \n                   results_pine3$Height_season_2_rhoave_BAYENV, use=\"pairwise\"),\n          xlim=c(-0.6,0.6), ylim=c(-0.3,0.3),\n          xlab=\"Uncorrected correlation\",\n          ylab=\"Covariance-corrected correlation\"\n          )\nplot2Dcov(x=results_pine3$Height_season_2_snp_effect,\n          results_pine3$Height_season_2_rhoave_BAYENV, \n          nbin=100, PElab = c(\"x\", \"y\"), \n          PE = cor(results_pine3$Height_season_2_snp_effect, \n                   results_pine3$Height_season_2_rhoave_BAYENV, use=\"pairwise\"),\n          xlim=c(-1,1), ylim=c(-0.3,0.3),\n          xlab=\"GCTA effect size\",\n          ylab=\"Covariance-corrected correlation\"\n          )\n\nmtext(\"Winter cold injury\", adj=0.2, side=3, outer=TRUE, line=-1)\nmtext(\"Height season 2\", adj=0.85, side=3, outer=TRUE, line=-1)\ndev.off()\n```\n",
    "created" : 1498685502049.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "850885431",
    "id" : "749A645F",
    "lastKnownWriteTime" : 1501872710,
    "last_content_update" : 1501872710258,
    "path" : "~/Desktop/CurrResearch/1-AdaptreeData/201509_PEGA/20170701Submit/dryad/analysis/AnalysisPEGA_3_dryad.Rmd",
    "project_path" : "AnalysisPEGA_3_dryad.Rmd",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}